# MessageHub - Complete Setup Instructions

## Current Status ‚úÖ

**Production:** https://messagehub.space  
**Server:** Ubuntu 22.04 @ 89.116.33.117  
**Build:** Successfully compiled (19 pages)  
**SSL:** Active with Let's Encrypt  
**Authentication:** Working via Supabase  
**Database:** Migrated (12 tables with RLS)  
**APIs:** All 37 endpoints functional  

---

## üöÄ Quick Setup (5 Steps)

### Step 1: Database Migrations

**CRITICAL:** Run these in your Supabase SQL Editor (https://supabase.com/dashboard ‚Üí SQL Editor)

#### Complete Database Schema (Run This Once)
```sql
-- Copy and paste entire content from:
-- File: supabase-migrations/001_complete_schema.sql

-- This creates all 12 tables:
-- ‚úì users (with role column)
-- ‚úì user_tokens (billing system)
-- ‚úì chatrooms (Twilio channels)
-- ‚úì user_chatrooms (multi-tenant assignments)
-- ‚úì contacts
-- ‚úì groups
-- ‚úì group_members
-- ‚úì templates
-- ‚úì sender_numbers
-- ‚úì settings
-- ‚úì messages (unified inbox/outbox)
-- ‚úì inbound_messages
```

**Verify migrations:**
```sql
-- Check if all tables exist:
SELECT table_name FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name IN (
  'user_tokens', 'user_chatrooms', 'chatrooms', 
  'contacts', 'groups', 'templates', 
  'messages', 'inbound_messages'
)
ORDER BY table_name;

-- Should return 8+ table names
```

---

### Step 2: Create Your First User

**Via Supabase SQL Editor (Recommended for Production)**

Since your `users` table is separate from Supabase Auth, create users directly:

```sql
-- Create admin user
INSERT INTO users (email, name, role)
VALUES ('admin@messagehub.space', 'Admin User', 'admin');

-- Verify
SELECT id, email, name, role FROM users;
```

> **Note:** The user you just created in the `users` table must also exist in Supabase Auth for password login to work. Set up their email and password in the Supabase Auth dashboard. The SQL insert above only adds the user to your app database; authentication is managed separately in Supabase Auth.

---

### Step 3: Verify Token System

Check that tokens were auto-created:

```sql
-- View all user tokens
SELECT 
  u.email,
  u.role,
  ut.balance,
  ut.created_at
FROM users u
LEFT JOIN user_tokens ut ON u.id = ut.user_id;

-- All users should have 100 tokens
```

If a user is missing tokens, the trigger will create them automatically on next insert. Or manually add:

```sql
INSERT INTO user_tokens (user_id, balance)
SELECT id, 100 FROM users
WHERE id NOT IN (SELECT user_id FROM user_tokens);
```

---

### Step 4: Create Test Chatrooms

```sql
-- Create test chatrooms with Twilio numbers
INSERT INTO chatrooms (name, twilio_number)
VALUES 
  ('Support Team', '+15551234567'),
  ('Sales Team', '+15557654321');

-- Verify:
SELECT id, name, twilio_number, created_at FROM chatrooms;
```

**Assign admin to all chatrooms:**

```sql
-- Get admin user ID and assign to all chatrooms
INSERT INTO user_chatrooms (user_id, chatroom_id)
SELECT 
  u.id,
  c.id
FROM users u
CROSS JOIN chatrooms c
WHERE u.role = 'admin';

-- Verify assignments
SELECT 
  u.email,
  c.name as chatroom_name
FROM user_chatrooms uc
JOIN users u ON uc.user_id = u.id
JOIN chatrooms c ON uc.chatroom_id = c.id;
```

---

### Step 5: Access MessageHub

**Production URL:** https://messagehub.space

1. **Open:** https://messagehub.space/Login
2. **Enter credentials:**
   - Email: `admin@messagehub.space`
   - Password: (set in Supabase Auth)
3. **Click "Sign In"**
4. **Should redirect to:** https://messagehub.space/Dashboard

‚úÖ **Success!** You're now logged in as an admin.

---

## üñ•Ô∏è Server Management

### PM2 Process Manager

```bash
# SSH into server
ssh root@89.116.33.117

# Check app status
pm2 status

# View logs
pm2 logs messagehub-client --lines 100

# Restart app
pm2 restart messagehub-client

# Stop app
pm2 stop messagehub-client

# Start app
cd /var/www/messagehub
pm2 start npm --name "messagehub-client" -- start
pm2 save
```

### Update Production Code

```bash
# SSH into server
ssh root@89.116.33.117
cd /var/www/messagehub

# Pull latest code
git pull origin main

# Install new dependencies (if any)
npm install

# Rebuild
npm run build

# Restart
pm2 restart messagehub-client
```

### Nginx Management

```bash
# Test configuration
nginx -t

# Reload (without downtime)
systemctl reload nginx

# Restart
systemctl restart nginx

# Check status
systemctl status nginx

# View error logs
tail -f /var/log/nginx/error.log
```

### SSL Certificate Renewal

Certificates auto-renew via certbot. To manually renew:

```bash
certbot renew
systemctl reload nginx
```

---

## üìã Post-Setup Checklist

### Verify Authentication Works
- [ ] Can login successfully
- [ ] Redirected to Dashboard after login
- [ ] Top bar shows your email and token balance (üí∞ 100)
- [ ] Logout works and redirects to /Login

### Verify Admin Access
- [ ] Can access `/admin/AdminTokens`
- [ ] Can access `/admin/AdminChatroomAccess`
- [ ] Can access `/admin/AdminUsers`
- [ ] Can see all chatrooms in Chatrooms list

### Verify Token System
- [ ] Token balance shows 100 in top bar
- [ ] Can view token balances in `/admin/AdminTokens`
- [ ] Can adjust token balances (+10/-10 buttons)

### Verify Chatroom Permissions
- [ ] Can assign users to chatrooms in `/admin/AdminChatroomAccess`
- [ ] Create a test "agent" user (role='agent')
- [ ] Login as agent and verify they see only assigned chatrooms

---

## üß™ Testing the System

### Test 1: Send SMS (Requires Twilio)

**Prerequisites:**
- Twilio account configured
- TWILIO_ACCOUNT_SID and TWILIO_AUTH_TOKEN in `.env.local`
- Sender number configured in database

**Steps:**
1. Go to `/SendSMS`
2. Select chatroom (uses that chatroom's Twilio number)
3. Enter recipient phone number
4. Enter message
5. Click "Send"
6. Check that 1 token was deducted
7. Verify message in Twilio dashboard

### Test 2: Real-Time Inbox

**Prerequisites:**
- Supabase Realtime enabled (free tier includes this)

**Steps:**
1. Open `/Inbox` in browser
2. Check for green "Live" indicator (Wifi icon)
3. In another browser/tab, insert a test inbound message:

```sql
INSERT INTO inbound_messages (from_number, chatroom_id, content)
VALUES (
  '+15559998888',
  (SELECT id FROM chatrooms LIMIT 1),
  'Test real-time message'
);
```

4. Message should appear in Inbox immediately (no refresh needed)

### Test 3: User-Chatroom Permissions

**Steps:**
1. Create agent user in Supabase Auth
2. Run SQL to add to users table:
```sql
INSERT INTO users (id, email, name, role)
VALUES (
  'agent-auth-id', 
  'agent@test.com', 
  'Test Agent', 
  'agent'
);
```

3. Login as admin
4. Go to `/admin/AdminChatroomAccess`
5. Assign agent to one chatroom
6. Logout and login as agent
7. Verify agent sees only that one chatroom

### Test 4: Run Automated Tests

```bash
# Make sure dev server is running on port 3001
npm run dev

# In another terminal:
npm run test:realtime
```

Expected output:
```
‚úì Environment variables loaded
‚úì Database connection successful
‚úì All tables accessible
‚úì API routes responding
‚úì Real-time subscriptions working
```

---

## üîß Troubleshooting

### Issue: "Invalid login credentials"

**Solution:**
1. Verify user exists in Supabase ‚Üí Authentication ‚Üí Users
2. Check that Auto-confirm was enabled when creating user
3. Try password reset if needed
4. Check `.env.local` has correct Supabase URL and key

### Issue: "401 Unauthorized" on all API calls

**Solution:**
1. Open browser DevTools ‚Üí Application ‚Üí Local Storage
2. Check if `sb-access-token` exists
3. If not, re-login
4. Clear cookies and cache if needed

### Issue: No chatrooms visible (agent user)

**Solution:**
1. Login as admin
2. Go to `/admin/AdminChatroomAccess`
3. Assign the agent to at least one chatroom
4. Logout and re-login as agent

### Issue: Tokens not deducting

**Solution:**
1. Verify `user_tokens` table exists:
```sql
SELECT * FROM user_tokens;
```

2. Check user has token balance:
```sql
SELECT * FROM user_tokens WHERE user_id = 'your-user-id';
```

3. If missing, manually create:
```sql
INSERT INTO user_tokens (user_id, balance)
VALUES ('your-user-id', 100);
```

### Issue: Real-time not working

**Solution:**
1. Check Supabase ‚Üí Database ‚Üí Replication
2. Ensure `inbound_messages` table has replication enabled
3. Check browser console for subscription errors
4. Verify Supabase Realtime is enabled in project settings

### Issue: Dev server on wrong port

**Solution:**
The dev server automatically uses port 3001 if 3000 is taken. Update URLs accordingly:
- Login: http://localhost:3001/Login
- Dashboard: http://localhost:3001/Dashboard

Or kill the process using port 3000:
```powershell
# Find process on port 3000
Get-NetTCPConnection -LocalPort 3000 | Select-Object OwningProcess -Unique

# Kill it (replace PID)
Stop-Process -Id <PID> -Force

# Restart dev server
npm run dev
```

---

## üìä Database Schema Reference

### Key Tables

**users**
```sql
id UUID PRIMARY KEY
email TEXT
name TEXT
role TEXT ('admin' or 'agent')
created_at TIMESTAMP
```

**user_tokens**
```sql
user_id UUID PRIMARY KEY ‚Üí users.id
balance INTEGER DEFAULT 100
updated_at TIMESTAMP
created_at TIMESTAMP
```

**user_chatrooms**
```sql
id UUID PRIMARY KEY
user_id UUID ‚Üí users.id
chatroom_id UUID ‚Üí chatrooms.id
created_at TIMESTAMP
UNIQUE(user_id, chatroom_id)
```

**chatrooms**
```sql
id UUID PRIMARY KEY
name TEXT
twilio_number TEXT
description TEXT
created_at TIMESTAMP
```

**messages**
```sql
id UUID PRIMARY KEY
chatroom_id UUID ‚Üí chatrooms.id
type TEXT ('sms' or 'email')
content TEXT
from_number TEXT
to_number TEXT
status TEXT
created_at TIMESTAMP
```

**inbound_messages**
```sql
id UUID PRIMARY KEY
chatroom_id UUID ‚Üí chatrooms.id
from_number TEXT
content TEXT
read BOOLEAN DEFAULT FALSE
created_at TIMESTAMP
```

---

## üéØ Next Steps

### Immediate
1. ‚úÖ Run database migrations
2. ‚úÖ Create admin user
3. ‚úÖ Login and explore
4. ‚úÖ Create test chatrooms
5. ‚úÖ Test token system

### Short-term
- [ ] Configure Twilio for SMS
- [ ] Add more users (agents)
- [ ] Assign chatroom permissions
- [ ] Import contacts
- [ ] Create message templates

### Production (COMPLETED ‚úÖ)
- [x] Deployed to VPS (89.116.33.117)
- [x] Custom domain (messagehub.space)
- [x] Production environment variables configured
- [x] HTTPS enabled (Let's Encrypt SSL)
- [x] PM2 process manager configured
- [x] Nginx reverse proxy configured
- [ ] Set up monitoring/logging (optional)
- [ ] Configure email notifications (optional)
- [ ] Set up backup system (recommended)

---

## üìñ Additional Resources

- **Migration Guide:** `MIGRATION_GUIDE.md` (Database setup)
- **Deployment Guide:** `DEPLOYMENT.md` (Server deployment)
- **Full Technical Documentation:** `IMPLEMENTATION_SUMMARY.md`
- **Test Report:** `TEST_REPORT.md`
- **Database Migrations:** `supabase-migrations/001_complete_schema.sql`

---

## üÜò Support

### Local Development Commands
```bash
# Start development server
npm run dev

# Build for production
npm run build

# Run production build locally
npm start

# Check for errors
npm run lint
```

### Production Server Commands
```bash
# SSH into server
ssh root@89.116.33.117

# Navigate to app directory
cd /var/www/messagehub

# View PM2 status
pm2 status

# View logs
pm2 logs messagehub-client

# Restart app
pm2 restart messagehub-client

# Update code from git
git pull origin main && npm install && npm run build && pm2 restart messagehub-client
```

### Environment Variables

**Production (.env.local on server):**
```bash
NEXT_PUBLIC_SUPABASE_URL=https://yudnnwdvrqcuonjblobr.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGc...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGc...
TWILIO_ACCOUNT_SID=your_account_sid
TWILIO_AUTH_TOKEN=your_auth_token
```

**Useful SQL Queries:**
```sql
-- View all users
SELECT * FROM users;

-- View token balances
SELECT u.email, ut.balance 
FROM users u 
LEFT JOIN user_tokens ut ON u.id = ut.user_id;

-- View chatroom assignments
SELECT u.email, c.name 
FROM user_chatrooms uc
JOIN users u ON uc.user_id = u.id
JOIN chatrooms c ON uc.chatroom_id = c.id;

-- View recent messages
SELECT * FROM messages 
ORDER BY created_at DESC 
LIMIT 20;
```

---

---

## üåê Access URLs

**Production:** https://messagehub.space  
**Server IP:** 89.116.33.117  
**Local Dev:** http://localhost:3001  

**Admin Pages:**
- Dashboard: https://messagehub.space/Dashboard
- Token Management: https://messagehub.space/admin/AdminTokens
- Chatroom Access: https://messagehub.space/admin/AdminChatroomAccess
- User Management: https://messagehub.space/admin/AdminUsers
- Message Logs: https://messagehub.space/admin/AdminMessageLogs

**Main Features:**
- Contacts: https://messagehub.space/Contacts
- Groups: https://messagehub.space/Groups
- Templates: https://messagehub.space/Templates
- Send SMS: https://messagehub.space/SendSMS
- Inbox: https://messagehub.space/Inbox

---

**Current Status:** ‚úÖ Production Ready  
**Deployment Date:** November 16, 2025  
**Version:** 1.0.0  
**Server:** Ubuntu 22.04.5 LTS  
**Node.js:** v20.19.5  
**Next.js:** 14.2.33  

üéâ **Your MessageHub instance is live at https://messagehub.space!**
