# MessageHub - Complete Setup Instructions

## Current Status âœ…

**Production:** https://messagehub.space  
**Server:** Ubuntu 22.04 @ 89.116.33.117  
**Build:** Successfully compiled (19 pages)  
**SSL:** Active with Let's Encrypt  
**Authentication:** Working via Supabase  
**Database:** Migrated (12 tables with RLS)  
**APIs:** All 37 endpoints functional  

---

## ðŸš€ Quick Setup (5 Steps)

### Step 1: Database Migrations

**CRITICAL:** Run these in your Supabase SQL Editor (https://supabase.com/dashboard â†’ SQL Editor)

#### Complete Database Schema (Run This Once)
```sql
-- Copy and paste entire content from:
-- File: supabase-migrations/001_complete_schema.sql

-- This creates all 12 tables:
-- âœ“ users (with role column)
-- âœ“ user_tokens (billing system)
-- âœ“ chatrooms (Twilio channels)
-- âœ“ user_chatrooms (multi-tenant assignments)
-- âœ“ contacts
-- âœ“ groups
-- âœ“ group_members
-- âœ“ templates
-- âœ“ sender_numbers
-- âœ“ settings
-- âœ“ messages (unified inbox/outbox)
-- âœ“ inbound_messages
```

**Verify migrations:**
```sql
-- Check if all tables exist:
SELECT table_name FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name IN (
  'user_tokens', 'user_chatrooms', 'chatrooms', 
  'contacts', 'groups', 'templates', 
  'messages', 'inbound_messages'
)
ORDER BY table_name;

-- Should return 8+ table names
```

---

### Step 2: Create Your First User

**Option A: Via Supabase Dashboard (Recommended)**
1. Go to https://supabase.com/dashboard
2. Select your project
3. Navigate to **Authentication â†’ Users**
4. Click **"Add User"** â†’ **"Create new user"**
5. Enter:
   - Email: `admin@yourdomain.com`
   - Password: `YourSecurePassword123!`
   - Auto-confirm: âœ… **Check this box**
6. Click **"Create user"**

**Option B: Via Signup (if enabled)**
1. Open http://localhost:3001/Login
2. Click "Sign Up" (if you add a signup page)
3. Enter email and password
4. Verify email if required

---

### Step 3: Promote User to Admin

After creating your first user, run this SQL:

```sql
-- Replace with your actual email
UPDATE users 
SET role = 'admin' 
WHERE email = 'admin@yourdomain.com';

-- Verify:
SELECT id, email, name, role FROM users;
```

**Note:** If you don't see the user in the `users` table:
1. Try logging in once (creates the profile automatically)
2. Or manually create the profile:

```sql
-- Get your auth user ID from Authentication dashboard
INSERT INTO users (id, email, name, role)
VALUES (
  'your-auth-user-id-here', 
  'admin@yourdomain.com', 
  'Admin User', 
  'admin'
);
```

---

### Step 4: Create Test Chatrooms

```sql
-- Create a test chatroom
INSERT INTO chatrooms (name, twilio_number, description)
VALUES 
  ('Support Team', '+15551234567', 'Main customer support line'),
  ('Sales Team', '+15557654321', 'Sales inquiries');

-- Verify:
SELECT * FROM chatrooms;
```

---

### Step 5: Login to MessageHub

1. **Open:** http://localhost:3001/Login
2. **Enter credentials:**
   - Email: `admin@yourdomain.com`
   - Password: `YourSecurePassword123!`
3. **Click "Sign In"**
4. **Should redirect to:** http://localhost:3001/Dashboard

âœ… **Success!** You're now logged in as an admin.

---

## ðŸ“‹ Post-Setup Checklist

### Verify Authentication Works
- [ ] Can login successfully
- [ ] Redirected to Dashboard after login
- [ ] Top bar shows your email and token balance (ðŸ’° 100)
- [ ] Logout works and redirects to /Login

### Verify Admin Access
- [ ] Can access `/admin/AdminTokens`
- [ ] Can access `/admin/AdminChatroomAccess`
- [ ] Can access `/admin/AdminUsers`
- [ ] Can see all chatrooms in Chatrooms list

### Verify Token System
- [ ] Token balance shows 100 in top bar
- [ ] Can view token balances in `/admin/AdminTokens`
- [ ] Can adjust token balances (+10/-10 buttons)

### Verify Chatroom Permissions
- [ ] Can assign users to chatrooms in `/admin/AdminChatroomAccess`
- [ ] Create a test "agent" user (role='agent')
- [ ] Login as agent and verify they see only assigned chatrooms

---

## ðŸ§ª Testing the System

### Test 1: Send SMS (Requires Twilio)

**Prerequisites:**
- Twilio account configured
- TWILIO_ACCOUNT_SID and TWILIO_AUTH_TOKEN in `.env.local`
- Sender number configured in database

**Steps:**
1. Go to `/SendSMS`
2. Select chatroom (uses that chatroom's Twilio number)
3. Enter recipient phone number
4. Enter message
5. Click "Send"
6. Check that 1 token was deducted
7. Verify message in Twilio dashboard

### Test 2: Real-Time Inbox

**Prerequisites:**
- Supabase Realtime enabled (free tier includes this)

**Steps:**
1. Open `/Inbox` in browser
2. Check for green "Live" indicator (Wifi icon)
3. In another browser/tab, insert a test inbound message:

```sql
INSERT INTO inbound_messages (from_number, chatroom_id, content)
VALUES (
  '+15559998888',
  (SELECT id FROM chatrooms LIMIT 1),
  'Test real-time message'
);
```

4. Message should appear in Inbox immediately (no refresh needed)

### Test 3: User-Chatroom Permissions

**Steps:**
1. Create agent user in Supabase Auth
2. Run SQL to add to users table:
```sql
INSERT INTO users (id, email, name, role)
VALUES (
  'agent-auth-id', 
  'agent@test.com', 
  'Test Agent', 
  'agent'
);
```

3. Login as admin
4. Go to `/admin/AdminChatroomAccess`
5. Assign agent to one chatroom
6. Logout and login as agent
7. Verify agent sees only that one chatroom

### Test 4: Run Automated Tests

```bash
# Make sure dev server is running on port 3001
npm run dev

# In another terminal:
npm run test:realtime
```

Expected output:
```
âœ“ Environment variables loaded
âœ“ Database connection successful
âœ“ All tables accessible
âœ“ API routes responding
âœ“ Real-time subscriptions working
```

---

## ðŸ”§ Troubleshooting

### Issue: "Invalid login credentials"

**Solution:**
1. Verify user exists in Supabase â†’ Authentication â†’ Users
2. Check that Auto-confirm was enabled when creating user
3. Try password reset if needed
4. Check `.env.local` has correct Supabase URL and key

### Issue: "401 Unauthorized" on all API calls

**Solution:**
1. Open browser DevTools â†’ Application â†’ Local Storage
2. Check if `sb-access-token` exists
3. If not, re-login
4. Clear cookies and cache if needed

### Issue: No chatrooms visible (agent user)

**Solution:**
1. Login as admin
2. Go to `/admin/AdminChatroomAccess`
3. Assign the agent to at least one chatroom
4. Logout and re-login as agent

### Issue: Tokens not deducting

**Solution:**
1. Verify `user_tokens` table exists:
```sql
SELECT * FROM user_tokens;
```

2. Check user has token balance:
```sql
SELECT * FROM user_tokens WHERE user_id = 'your-user-id';
```

3. If missing, manually create:
```sql
INSERT INTO user_tokens (user_id, balance)
VALUES ('your-user-id', 100);
```

### Issue: Real-time not working

**Solution:**
1. Check Supabase â†’ Database â†’ Replication
2. Ensure `inbound_messages` table has replication enabled
3. Check browser console for subscription errors
4. Verify Supabase Realtime is enabled in project settings

### Issue: Dev server on wrong port

**Solution:**
The dev server automatically uses port 3001 if 3000 is taken. Update URLs accordingly:
- Login: http://localhost:3001/Login
- Dashboard: http://localhost:3001/Dashboard

Or kill the process using port 3000:
```powershell
# Find process on port 3000
Get-NetTCPConnection -LocalPort 3000 | Select-Object OwningProcess -Unique

# Kill it (replace PID)
Stop-Process -Id <PID> -Force

# Restart dev server
npm run dev
```

---

## ðŸ“Š Database Schema Reference

### Key Tables

**users**
```sql
id UUID PRIMARY KEY
email TEXT
name TEXT
role TEXT ('admin' or 'agent')
created_at TIMESTAMP
```

**user_tokens**
```sql
user_id UUID PRIMARY KEY â†’ users.id
balance INTEGER DEFAULT 100
updated_at TIMESTAMP
created_at TIMESTAMP
```

**user_chatrooms**
```sql
id UUID PRIMARY KEY
user_id UUID â†’ users.id
chatroom_id UUID â†’ chatrooms.id
created_at TIMESTAMP
UNIQUE(user_id, chatroom_id)
```

**chatrooms**
```sql
id UUID PRIMARY KEY
name TEXT
twilio_number TEXT
description TEXT
created_at TIMESTAMP
```

**messages**
```sql
id UUID PRIMARY KEY
chatroom_id UUID â†’ chatrooms.id
type TEXT ('sms' or 'email')
content TEXT
from_number TEXT
to_number TEXT
status TEXT
created_at TIMESTAMP
```

**inbound_messages**
```sql
id UUID PRIMARY KEY
chatroom_id UUID â†’ chatrooms.id
from_number TEXT
content TEXT
read BOOLEAN DEFAULT FALSE
created_at TIMESTAMP
```

---

## ðŸŽ¯ Next Steps

### Immediate
1. âœ… Run database migrations
2. âœ… Create admin user
3. âœ… Login and explore
4. âœ… Create test chatrooms
5. âœ… Test token system

### Short-term
- [ ] Configure Twilio for SMS
- [ ] Add more users (agents)
- [ ] Assign chatroom permissions
- [ ] Import contacts
- [ ] Create message templates

### Production
- [ ] Deploy to Vercel/Railway
- [ ] Set up custom domain
- [ ] Configure production environment variables
- [ ] Enable HTTPS (required for cookies)
- [ ] Set up monitoring/logging
- [ ] Configure email notifications

---

## ðŸ“– Additional Resources

- **Full Technical Documentation:** `IMPLEMENTATION_SUMMARY.md`
- **Test Report:** `TEST_REPORT.md`
- **Quick Start:** `QUICKSTART.md`
- **Database Migrations:** `supabase-migrations/` folder

---

## ðŸ†˜ Support

**Common Commands:**
```bash
# Start development server
npm run dev

# Build for production
npm run build

# Run production build
npm start

# Run tests
npm run test:realtime

# Check for errors
npm run lint
```

**Useful SQL Queries:**
```sql
-- View all users
SELECT * FROM users;

-- View token balances
SELECT u.email, ut.balance 
FROM users u 
LEFT JOIN user_tokens ut ON u.id = ut.user_id;

-- View chatroom assignments
SELECT u.email, c.name 
FROM user_chatrooms uc
JOIN users u ON uc.user_id = u.id
JOIN chatrooms c ON uc.chatroom_id = c.id;

-- View recent messages
SELECT * FROM messages 
ORDER BY created_at DESC 
LIMIT 20;
```

---

**Current Status:** âœ… System Ready  
**Last Updated:** November 15, 2024  
**Version:** 1.0.0

ðŸŽ‰ **Your MessageHub instance is ready to use!**
