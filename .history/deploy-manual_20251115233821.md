# MessageHub - Manual Deployment Guide

## Server: 89.116.33.117

This guide walks you through deploying MessageHub to your production server manually.

---

## Prerequisites

- SSH access to server: `root@89.116.33.117`
- Git repository access
- Supabase project configured
- Domain name (optional)

---

## Step-by-Step Deployment

### 1. Connect to Server

```bash
ssh root@89.116.33.117
```

### 2. Install Node.js 18

```bash
# Update system
apt-get update && apt-get upgrade -y

# Install Node.js 18
curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
apt-get install -y nodejs

# Verify installation
node -v  # Should show v18.x.x
npm -v
```

### 3. Install PM2 Process Manager

```bash
npm install -g pm2

# Verify
pm2 -v
```

### 4. Install Nginx

```bash
apt-get install -y nginx

# Verify
nginx -v
```

### 5. Create Application Directory

```bash
mkdir -p /var/www/messagehub
cd /var/www/messagehub
```

### 6. Clone or Upload Application

**Option A: Clone from Git (if repository is accessible)**
```bash
git clone https://github.com/Lazycharm/massagehub-client.git .
```

**Option B: Upload from local machine**
```bash
# Run this on your LOCAL machine (PowerShell)
cd C:\messagehub-client

# Upload files via SCP
scp -r .next pages public src lib components node_modules package.json package-lock.json root@89.116.33.117:/var/www/messagehub/
```

**Option C: Use rsync (recommended)**
```bash
# Run this on your LOCAL machine
cd C:\messagehub-client

# Upload files (excluding unnecessary files)
rsync -avz --exclude 'node_modules' --exclude '.git' --exclude '.history' ./ root@89.116.33.117:/var/www/messagehub/
```

### 7. Install Dependencies on Server

```bash
# Back on the SERVER
cd /var/www/messagehub
npm install --production
```

### 8. Create Environment Variables

```bash
nano /var/www/messagehub/.env.local
```

Add your configuration:
```env
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
TWILIO_ACCOUNT_SID=your_twilio_sid
TWILIO_AUTH_TOKEN=your_twilio_token
NODE_ENV=production
```

Save with `Ctrl+O`, `Enter`, then exit with `Ctrl+X`

### 9. Build Application (if not already built)

```bash
cd /var/www/messagehub
npm run build
```

### 10. Start Application with PM2

```bash
# Start the app
pm2 start npm --name messagehub -- start

# Save PM2 configuration
pm2 save

# Setup PM2 to start on boot
pm2 startup systemd

# Verify it's running
pm2 status
pm2 logs messagehub
```

### 11. Configure Nginx Reverse Proxy

```bash
nano /etc/nginx/sites-available/messagehub
```

Add this configuration:
```nginx
server {
    listen 80;
    server_name 89.116.33.117;  # Or your domain name

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

Enable the site:
```bash
# Create symbolic link
ln -s /etc/nginx/sites-available/messagehub /etc/nginx/sites-enabled/

# Remove default site
rm /etc/nginx/sites-enabled/default

# Test configuration
nginx -t

# Reload Nginx
systemctl reload nginx
```

### 12. Configure Firewall

```bash
# Install UFW (if not already installed)
apt-get install -y ufw

# Allow SSH (important - don't lock yourself out!)
ufw allow 22/tcp

# Allow HTTP and HTTPS
ufw allow 80/tcp
ufw allow 443/tcp

# Enable firewall
ufw enable

# Check status
ufw status
```

### 13. Verify Deployment

```bash
# Check PM2 status
pm2 status

# Check application logs
pm2 logs messagehub --lines 50

# Check Nginx status
systemctl status nginx

# Test the application
curl http://localhost:3000
```

### 14. Access Your Application

Open in browser:
```
http://89.116.33.117
```

Or if you have a domain:
```
http://yourdomain.com
```

---

## Post-Deployment Tasks

### 1. Apply Database Migrations

1. Login to Supabase Dashboard
2. Go to SQL Editor
3. Run `supabase-migrations/001_user_tokens.sql`
4. Run `supabase-migrations/002_user_chatrooms.sql`

### 2. Create Admin User

1. Supabase Dashboard → Authentication → Users
2. Click "Add User"
3. Enter email and password
4. Check "Auto-confirm user"
5. Create user

### 3. Promote to Admin

In Supabase SQL Editor:
```sql
UPDATE users 
SET role = 'admin' 
WHERE email = 'your-admin-email@example.com';
```

### 4. Test Login

1. Go to http://89.116.33.117/Login
2. Enter admin credentials
3. Should redirect to Dashboard

---

## Optional: SSL/HTTPS Setup

### Install Certbot (Let's Encrypt)

```bash
# Install certbot
apt-get install -y certbot python3-certbot-nginx

# Get SSL certificate (replace with your domain)
certbot --nginx -d yourdomain.com

# Auto-renewal is setup automatically
# Test renewal:
certbot renew --dry-run
```

The Nginx config will be automatically updated for HTTPS.

---

## Management Commands

### PM2 Commands

```bash
# View status
pm2 status

# View logs
pm2 logs messagehub

# Restart app
pm2 restart messagehub

# Stop app
pm2 stop messagehub

# Start app
pm2 start messagehub

# Delete app from PM2
pm2 delete messagehub
```

### Nginx Commands

```bash
# Test configuration
nginx -t

# Reload (no downtime)
systemctl reload nginx

# Restart
systemctl restart nginx

# Status
systemctl status nginx

# View error logs
tail -f /var/log/nginx/error.log

# View access logs
tail -f /var/log/nginx/access.log
```

### Application Updates

When you need to deploy updates:

```bash
# On your LOCAL machine, build and upload
cd C:\messagehub-client
npm run build
rsync -avz --exclude 'node_modules' ./ root@89.116.33.117:/var/www/messagehub/

# On the SERVER, install deps and restart
ssh root@89.116.33.117
cd /var/www/messagehub
npm install --production
pm2 restart messagehub
```

---

## Troubleshooting

### Application won't start

```bash
# Check logs
pm2 logs messagehub --lines 100

# Check if port 3000 is in use
netstat -tulpn | grep 3000

# Check environment variables
cat /var/www/messagehub/.env.local
```

### Nginx errors

```bash
# Check error logs
tail -100 /var/log/nginx/error.log

# Test configuration
nginx -t

# Check if Nginx is running
systemctl status nginx
```

### Can't access application

```bash
# Check firewall
ufw status

# Check if app is running
pm2 status

# Check if Nginx is running
systemctl status nginx

# Test locally on server
curl http://localhost:3000
```

### Database connection issues

```bash
# Check environment variables
cat /var/www/messagehub/.env.local

# Test connection (on server)
cd /var/www/messagehub
node -e "require('dotenv').config({path:'.env.local'}); console.log(process.env.NEXT_PUBLIC_SUPABASE_URL)"
```

---

## Monitoring

### Setup Logging

```bash
# PM2 logs are automatic, view with:
pm2 logs messagehub

# Setup log rotation
pm2 install pm2-logrotate

# Configure (optional)
pm2 set pm2-logrotate:max_size 10M
pm2 set pm2-logrotate:retain 30
```

### Monitor Resources

```bash
# View PM2 monitoring dashboard
pm2 monit

# View system resources
htop

# View disk usage
df -h
```

---

## Backup Strategy

### Application Backup

```bash
# Backup application files
tar -czf messagehub-backup-$(date +%Y%m%d).tar.gz /var/www/messagehub

# Backup to remote location (optional)
scp messagehub-backup-*.tar.gz user@backup-server:/backups/
```

### Database Backup

Your database is in Supabase, which has automatic backups. To create manual backup:
1. Supabase Dashboard → Database → Backups
2. Click "Create Backup"

---

## Performance Optimization

### Enable Gzip in Nginx

Add to nginx config:
```nginx
gzip on;
gzip_vary on;
gzip_proxied any;
gzip_comp_level 6;
gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss;
```

### PM2 Cluster Mode

For better performance with multiple CPU cores:
```bash
pm2 delete messagehub
pm2 start npm --name messagehub -i max -- start
pm2 save
```

---

## Security Checklist

- [ ] Firewall configured (UFW)
- [ ] SSL/HTTPS enabled
- [ ] Environment variables secured
- [ ] Database connection secure
- [ ] Regular updates scheduled
- [ ] Backup strategy in place
- [ ] Monitoring configured

---

## Support

**Documentation:**
- SETUP_GUIDE.md
- ARCHITECTURE.md
- CHECKLIST.md

**Logs Location:**
- PM2: `~/.pm2/logs/`
- Nginx: `/var/log/nginx/`
- System: `/var/log/syslog`

---

**Last Updated:** November 15, 2024  
**Server:** 89.116.33.117  
**Application:** MessageHub v1.0.0
